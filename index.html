<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webhook Dashboard - Vercel</title>
    <style>
        :root {
            --background-color: #121212;
            --surface-color: #1e1e1e;
            --primary-text-color: #e0e0e0;
            --secondary-text-color: #a0a0a0;
            --border-color: #333;
            --user-bubble-color: #373737;

            --tumÃ¼-color: #03dac6;
            --instagram-color: #E4405F;
            --facebook-color: #1877F2;
            --whatsapp-color: #25D366;
            --telegram-color: #0088cc;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--primary-text-color);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s;
        }

        .tabs-container { 
            display: flex; 
            justify-content: center; 
            padding: 1rem 0; 
            border-bottom: 1px solid var(--border-color); 
            flex-shrink: 0; 
        }
        
        .tab-btn {
            display: flex; 
            align-items: center; 
            gap: 0.5rem;
            padding: 0.75rem 1.5rem; 
            font-size: 1.1rem; 
            font-weight: 600; 
            cursor: pointer;
            border: none; 
            background: none; 
            color: var(--secondary-text-color);
            border-bottom: 3px solid transparent; 
            transition: all 0.2s ease;
        }
        
        .tab-btn:hover { color: var(--primary-text-color); }
        .tab-btn svg { width: 20px; height: 20px; fill: currentColor; }

        .tab-btn.active.tumÃ¼ { color: var(--tumÃ¼-color); border-bottom-color: var(--tumÃ¼-color); }
        .tab-btn.active.instagram { color: var(--instagram-color); border-bottom-color: var(--instagram-color); }
        .tab-btn.active.facebook { color: var(--facebook-color); border-bottom-color: var(--facebook-color); }
        .tab-btn.active.whatsapp { color: var(--whatsapp-color); border-bottom-color: var(--whatsapp-color); }
        .tab-btn.active.telegram { color: var(--telegram-color); border-bottom-color: var(--telegram-color); }

        .main-content { display: flex; flex-grow: 1; overflow: hidden; }
        .sidebar { width: 300px; flex-shrink: 0; border-right: 1px solid var(--border-color); overflow-y: auto; }
        
        .user-card { 
            padding: 1rem; 
            border-bottom: 1px solid var(--border-color); 
            cursor: pointer; 
            position: relative; 
        }
        
        .user-card:hover { background-color: var(--surface-color); }
        .user-card .user-id { font-weight: bold; }
        .user-card .platform-badge { font-size: 0.8rem; font-weight: bold; margin-left: 8px; }
        .user-card .last-message { 
            font-size: 0.9rem; 
            color: var(--secondary-text-color); 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        
        .test-badge { 
            position: absolute; 
            top: 5px; 
            right: 5px; 
            background-color: #ffab00; 
            color: #000; 
            font-size: 0.7rem; 
            font-weight: bold; 
            padding: 2px 5px; 
            border-radius: 4px; 
        }

        body.theme-tumÃ¼ .user-card.active { background-color: var(--tumÃ¼-color); color: #000; }
        body.theme-instagram .user-card.active { background-color: var(--instagram-color); color: #fff; }
        body.theme-facebook .user-card.active { background-color: var(--facebook-color); color: #fff; }
        body.theme-whatsapp .user-card.active { background-color: var(--whatsapp-color); color: #fff; }
        body.theme-telegram .user-card.active { background-color: var(--telegram-color); color: #fff; }
        body .user-card.active .platform-badge { color: #000; }

        .chat-area { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .chat-messages { flex-grow: 1; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; }
        
        .message-bubble {
            max-width: 70%;
            padding: 0.75rem;
            border-radius: 12px;
            margin-bottom: 0.5rem;
            word-wrap: break-word;
        }
        
        .message-bubble.user {
            background-color: var(--user-bubble-color);
            align-self: flex-start;
            border-bottom-left-radius: 2px;
        }
        
        .message-bubble.agent {
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }
        
        .message-meta {
            font-size: 0.75rem;
            color: var(--secondary-text-color);
            margin-top: 0.5rem;
        }
        
        .placeholder { margin: auto; text-align: center; color: var(--secondary-text-color); }

        body.theme-tumÃ¼ .message-bubble.agent { background-color: #004d40; }
        body.theme-instagram .message-bubble.agent { background-color: var(--instagram-color); }
        body.theme-facebook .message-bubble.agent { background-color: var(--facebook-color); }
        body.theme-whatsapp .message-bubble.agent { background-color: var(--whatsapp-color); }
        body.theme-telegram .message-bubble.agent { background-color: var(--telegram-color); }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .connection-status.connected {
            background-color: #4caf50;
            color: white;
        }
        
        .connection-status.disconnected {
            background-color: #f44336;
            color: white;
        }

        .connection-status.reconnecting {
            background-color: #ff9800;
            color: white;
        }
    </style>
</head>
<body class="theme-tumÃ¼">

    <div class="connection-status" id="connection-status">BaÄŸlanÄ±yor...</div>

    <div class="tabs-container" id="tabs-container">
        <button class="tab-btn active tumÃ¼" data-platform="tumÃ¼">
            <svg viewBox="0 0 24 24"><path d="M12,12L19.07,19.07L12,26.14L4.93,19.07L12,12M12,4.93L19.07,12L12,19.07L4.93,12L12,4.93M12,2.1L21.9,12L12,21.9L2.1,12L12,2.1Z" fill="currentColor"/></svg>
            TÃ¼mÃ¼
        </button>
        <button class="tab-btn facebook" data-platform="facebook">
            <svg viewBox="0 0 24 24"><path d="M12 2.04C6.5 2.04 2 6.53 2 12.06C2 17.06 5.66 21.21 10.44 21.96V14.96H7.9V12.06H10.44V9.85C10.44 7.32 11.93 5.96 14.22 5.96C15.31 5.96 16.45 6.15 16.45 6.15V8.62H15.19C13.95 8.62 13.56 9.39 13.56 10.18V12.06H16.34L15.89 14.96H13.56V21.96A10 10 0 0 0 22 12.06C22 6.53 17.5 2.04 12 2.04Z" /></svg>
            Facebook
        </button>
        <button class="tab-btn instagram" data-platform="instagram">
            <svg viewBox="0 0 24 24"><path d="M7.8,2H16.2C19.4,2 22,4.6 22,7.8V16.2A5.8,5.8 0 0,1 16.2,22H7.8C4.6,22 2,19.4 2,16.2V7.8A5.8,5.8 0 0,1 7.8,2M7.6,4A3.6,3.6 0 0,0 4,7.6V16.4C4,18.39 5.61,20 7.6,20H16.4A3.6,3.6 0 0,0 20,16.4V7.6C20,5.61 18.39,4 16.4,4H7.6M17.25,5.5A1.25,1.25 0 0,1 18.5,6.75A1.25,1.25 0 0,1 17.25,8A1.25,1.25 0 0,1 16,6.75A1.25,1.25 0 0,1 17.25,5.5M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9Z" /></svg>
            Instagram
        </button>
        <button class="tab-btn whatsapp" data-platform="whatsapp">
            <svg viewBox="0 0 24 24"><path d="M12.04 2C6.58 2 2.13 6.45 2.13 12C2.13 14.06 2.69 16.01 3.69 17.65L2.5 21.5L6.41 20.35C7.99 21.29 9.94 21.87 12.04 21.87C17.5 21.87 21.95 17.42 21.95 11.96C21.95 6.5 17.5 2 12.04 2M12.04 3.63C16.56 3.63 20.23 7.3 20.23 11.96C20.23 16.62 16.56 20.29 12.04 20.29C10.2 20.29 8.48 19.77 7.09 18.9L6.75 18.71L4.63 19.37L5.3 17.31L5.1 16.96C4.26 15.54 3.76 13.81 3.76 12C3.76 7.3 7.43 3.63 12.04 3.63M9.23 7.76C9.06 7.76 8.81 7.85 8.58 8.2C8.35 8.55 7.81 9.15 7.81 10.23C7.81 11.31 8.59 12.34 8.72 12.51C8.85 12.68 10.17 14.82 12.25 15.64C13.95 16.32 14.33 16.2 14.78 16.15C15.23 16.11 16.09 15.61 16.32 15.06C16.55 14.51 16.55 14.06 16.46 13.93C16.37 13.8 16.2 13.71 15.93 13.58C15.66 13.45 14.44 12.85 14.21 12.76C13.98 12.68 13.81 12.64 13.65 12.85C13.49 13.07 13.03 13.62 12.89 13.79C12.75 13.96 12.62 14 12.39 13.87C12.16 13.74 11.29 13.45 10.23 12.58C9.41 11.91 8.86 11.08 8.72 10.86C8.58 10.64 8.71 10.5 8.84 10.37C8.96 10.26 9.1 10.09 9.23 9.96C9.36 9.83 9.41 9.74 9.54 9.53C9.67 9.31 9.62 9.14 9.58 9.01C9.54 8.87 9.36 8.26 9.23 7.76Z" /></svg>
            WhatsApp
        </button>
        <button class="tab-btn telegram" data-platform="telegram">
            <svg viewBox="0 0 24 24"><path d="M9.78,18.65L10.26,14.21L18.83,7.5C19.33,7.12 18.94,6.5 18.36,6.7L8.24,11.41L3.7,9.94C3.18,9.76 3.18,9.14 3.72,8.93L20.5,2.32C21.1,2.09 21.8,2.58 21.6,3.23L18.09,19.33C17.84,20.24 16.88,20.38 16.4,19.55L12.8,15.94L10.74,17.94C10.5,18.18 10.15,18.2 9.78,18.05L9.78,18.65Z" /></svg>
            Telegram
        </button>
    </div>

    <main class="main-content">
        <aside class="sidebar" id="sidebar">
            <div class="placeholder">KullanÄ±cÄ± seÃ§in</div>
        </aside>
        <section class="chat-area" id="chat-area">
            <div class="chat-messages" id="chat-messages">
                <div class="placeholder">Mesajlar burada gÃ¶rÃ¼necek</div>
            </div>
        </section>
    </main>

    <script>
        let state = {
            tabs: {
                'tumÃ¼': { users: {}, order: [] },
                'facebook': { users: {}, order: [] },
                'instagram': { users: {}, order: [] },
                'whatsapp': { users: {}, order: [] },
                'telegram': { users: {}, order: [] },
            },
            activePlatform: 'tumÃ¼',
            activeUserId: null,
        };
        
        const messageHashes = new Set();
        let eventSource = null;
        let reconnectTimeout = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        const tabsContainer = document.getElementById('tabs-container');
        const sidebar = document.getElementById('sidebar');
        const chatMessages = document.getElementById('chat-messages');
        const connectionStatus = document.getElementById('connection-status');
        const body = document.body;

        function updateConnectionStatus(status) {
            const statusText = {
                'connected': 'Bağlı',
                'disconnected': 'Bağlantı Kesildi',
                'reconnecting': 'Yeniden Bağlanıyor...',
                'connecting': 'Bağlanıyor...'
            };
            
            connectionStatus.textContent = statusText[status] || status;
            connectionStatus.className = `connection-status ${status}`;
        }

        function parseCustomTimestamp(ts) {
            if (!ts || typeof ts !== 'string') return new Date().toISOString();
            if (ts.includes('T')) return new Date(ts).toISOString();
            const parts = ts.match(/(\d+)/g);
            if (!parts || parts.length < 5) return new Date().toISOString();
            return new Date(parts[2], parts[1] - 1, parts[0], parts[3], parts[4]).toISOString();
        }

        function renderUserList() {
            sidebar.innerHTML = '';
            const platformState = state.tabs[state.activePlatform];
            
            if (!platformState || platformState.order.length === 0) {
                sidebar.innerHTML = `<div class="placeholder">Bu platform için kullanıcı yok</div>`;
                return;
            }
            
            platformState.order.forEach(compositeUserId => {
                const thread = platformState.users[compositeUserId];
                const card = document.createElement('div');
                card.className = `user-card ${compositeUserId === state.activeUserId ? 'active' : ''}`;
                card.dataset.userId = compositeUserId;
                
                const lastMessage = thread.messages[thread.messages.length - 1];
                const isTest = thread.messages.some(m => m.test);
                const platformName = thread.platform.charAt(0).toUpperCase() + thread.platform.slice(1);
                
                card.innerHTML = `
                    ${isTest ? '<div class="test-badge">TEST</div>' : ''}
                    <div class="user-id">
                        ${thread.userId}
                        ${state.activePlatform === 'tumÃ¼' ? `<span class="platform-badge" style="color:var(--${thread.platform}-color)">${platformName}</span>` : ''}
                    </div>
                    <div class="last-message">${lastMessage ? lastMessage.text : 'Mesaj yok'}</div>
                `;
                
                sidebar.appendChild(card);
            });
        }

        function renderChat() {
            chatMessages.innerHTML = '';
            
            if (!state.activeUserId) {
                chatMessages.innerHTML = '<div class="placeholder">Mesajları görmek için bir kullanıcı seçin</div>';
                return;
            }
            
            const platformStateKey = state.activePlatform === 'tumÃ¼' ? 'tumÃ¼' : state.activePlatform;
            const thread = state.tabs[platformStateKey]?.users[state.activeUserId];
            
            if (!thread) {
                chatMessages.innerHTML = '<div class="placeholder">Mesajlar yüklenemedi.</div>';
                return;
            }

            thread.messages.forEach(msg => {
                const bubble = document.createElement('div');
                bubble.className = `message-bubble ${msg.from}`;
                
                const localTimestamp = new Date(msg.timestamp).toLocaleString('tr-TR', {
                    hour: '2-digit',
                    minute: '2-digit',
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                
                bubble.innerHTML = `
                    <div>${msg.text}</div>
                    <div class="message-meta">
                        <span>${localTimestamp}</span>
                        ${msg.source ? `<span> • ${msg.source}</span>` : ''}
                    </div>
                `;
                
                chatMessages.appendChild(bubble);
            });
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function renderAll() {
            renderUserList();
            renderChat();
        }

        function setActiveTheme(platform) {
            body.className = `theme-${platform}`;
        }

        function processMessage(data) {
            // Ping mesajlarını yoksay
            if (data.type === 'ping') return;
            
            const { platform, 'user-id': userId, 'user-message': userMessage, 'agent-message': agentMessage, timestamp, source, test } = data;
            const isoTimestamp = parseCustomTimestamp(timestamp);
            const currentPlatform = platform ? platform.toLowerCase() : null;
            
            if (!currentPlatform || !state.tabs[currentPlatform]) {
                console.warn(`Unknown platform: ${currentPlatform}`);
                return;
            }
            
            const currentUserId = userId || `unknown-${Math.random().toString(36).substr(2, 5)}`;

            const newMessages = [];
            [
                { from: 'user', text: userMessage },
                { from: 'agent', text: agentMessage }
            ].forEach(msgData => {
                if (msgData.text) {
                    const hash = `${currentPlatform}-${currentUserId}-${msgData.text}-${isoTimestamp}`;
                    if (!messageHashes.has(hash)) {
                        messageHashes.add(hash);
                        newMessages.push({
                            id: hash,
                            from: msgData.from,
                            text: msgData.text,
                            timestamp: isoTimestamp,
                            source,
                            test
                        });
                    }
                }
            });

            if (newMessages.length === 0) return;

            ['tumÃ¼', currentPlatform].forEach(platformKey => {
                const platformState = state.tabs[platformKey];
                const compositeUserId = platformKey === 'tumÃ¼' ? `${currentPlatform}-${currentUserId}` : currentUserId;
                
                if (!platformState.users[compositeUserId]) {
                    platformState.users[compositeUserId] = {
                        platform: currentPlatform,
                        userId: currentUserId,
                        messages: [],
                        lastUpdated: isoTimestamp
                    };
                }
                
                const userThread = platformState.users[compositeUserId];
                userThread.messages.push(...newMessages);
                userThread.messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                userThread.lastUpdated = isoTimestamp;
                
                const order = platformState.order;
                const userIndex = order.indexOf(compositeUserId);
                if (userIndex > -1) order.splice(userIndex, 1);
                order.unshift(compositeUserId);
            });

            renderAll();
        }

        function connectEventSource() {
            if (eventSource) {
                eventSource.close();
            }

            updateConnectionStatus('connecting');
            
            try {
                eventSource = new EventSource('/api/events');

                eventSource.onopen = function() {
                    console.log('SSE connection established');
                    updateConnectionStatus('connected');
                    reconnectAttempts = 0;
                    
                    if (reconnectTimeout) {
                        clearTimeout(reconnectTimeout);
                        reconnectTimeout = null;
                    }
                };

                eventSource.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        processMessage(data);
                    } catch (error) {
                        console.error('Error parsing SSE message:', error);
                    }
                };

                eventSource.onerror = function(error) {
                    console.error('SSE error:', error);
                    eventSource.close();
                    
                    updateConnectionStatus('disconnected');
                    
                    // Yeniden bağlanma mantığı
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        updateConnectionStatus('reconnecting');
                        
                        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                        
                        reconnectTimeout = setTimeout(() => {
                            console.log(`Attempting to reconnect (${reconnectAttempts}/${maxReconnectAttempts})`);
                            connectEventSource();
                        }, delay);
                    } else {
                        console.log('Max reconnection attempts reached');
                        updateConnectionStatus('disconnected');
                    }
                };
            } catch (error) {
                console.error('Failed to create EventSource:', error);
                updateConnectionStatus('disconnected');
            }
        }

        // Event Listeners
        tabsContainer.addEventListener('click', e => {
            const tabButton = e.target.closest('.tab-btn');
            if (tabButton) {
                document.querySelector('.tab-btn.active').classList.remove('active');
                tabButton.classList.add('active');
                state.activePlatform = tabButton.dataset.platform;
                state.activeUserId = null;
                setActiveTheme(state.activePlatform);
                renderAll();
            }
        });

        sidebar.addEventListener('click', e => {
            const card = e.target.closest('.user-card');
            if (card) {
                state.activeUserId = card.dataset.userId;
                renderAll();
            }
        });

        // Sayfa kapanırken bağlantıyı kapat
        window.addEventListener('beforeunload', () => {
            if (eventSource) {
                eventSource.close();
            }
            if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
            }
        });

        // Sayfa yüklendiğinde başlat
        document.addEventListener('DOMContentLoaded', () => {
            renderAll();
            connectEventSource();
        });
    </script>
</body>
</html>